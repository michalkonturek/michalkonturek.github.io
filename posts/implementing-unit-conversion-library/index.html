<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Michal Konturek"><meta name=description content="Last week I decided to implement unit conversion library for Objective-C called MKUnits. I was fully aware that there were many open-sourced implementation already available, but unfortunately none of them fitted my needs.
I required a library that:
 is easily extendable has built-in rounding functionality is precise up to at least 10 decimal places allows manipulation between units of the same group, i.e. kg and pounds, without the need of conversion  Quantity Pattern Before I started coding, I had a quick read through the chapter of Analysis Patterns by Martin Fowler, which describes the Quantity Pattern."><meta name=keywords content=",ios,swift,oss,patterns"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://michal.codes/posts/implementing-unit-conversion-library/><title>Implementing Unit conversion library :: Michal Konturek</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.ddc8d995c31f1883cdbac184173d8cea2764c96f6cf099374512f7ded85e541a.css><meta itemprop=name content="Implementing Unit conversion library"><meta itemprop=description content="Last week I decided to implement unit conversion library for Objective-C called MKUnits. I was fully aware that there were many open-sourced implementation already available, but unfortunately none of them fitted my needs.
I required a library that:
 is easily extendable has built-in rounding functionality is precise up to at least 10 decimal places allows manipulation between units of the same group, i.e. kg and pounds, without the need of conversion  Quantity Pattern Before I started coding, I had a quick read through the chapter of Analysis Patterns by Martin Fowler, which describes the Quantity Pattern."><meta itemprop=datePublished content="2013-07-01T18:19:29+01:00"><meta itemprop=dateModified content="2013-07-01T18:19:29+01:00"><meta itemprop=wordCount content="639"><meta itemprop=image content="https://michal.codes"><meta itemprop=keywords content="ios,swift,oss,patterns,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://michal.codes"><meta name=twitter:title content="Implementing Unit conversion library"><meta name=twitter:description content="Last week I decided to implement unit conversion library for Objective-C called MKUnits. I was fully aware that there were many open-sourced implementation already available, but unfortunately none of them fitted my needs.
I required a library that:
 is easily extendable has built-in rounding functionality is precise up to at least 10 decimal places allows manipulation between units of the same group, i.e. kg and pounds, without the need of conversion  Quantity Pattern Before I started coding, I had a quick read through the chapter of Analysis Patterns by Martin Fowler, which describes the Quantity Pattern."><meta property="og:title" content="Implementing Unit conversion library"><meta property="og:description" content="Last week I decided to implement unit conversion library for Objective-C called MKUnits. I was fully aware that there were many open-sourced implementation already available, but unfortunately none of them fitted my needs.
I required a library that:
 is easily extendable has built-in rounding functionality is precise up to at least 10 decimal places allows manipulation between units of the same group, i.e. kg and pounds, without the need of conversion  Quantity Pattern Before I started coding, I had a quick read through the chapter of Analysis Patterns by Martin Fowler, which describes the Quantity Pattern."><meta property="og:type" content="article"><meta property="og:url" content="https://michal.codes/posts/implementing-unit-conversion-library/"><meta property="og:image" content="https://michal.codes"><meta property="article:published_time" content="2013-07-01T18:19:29+01:00"><meta property="article:modified_time" content="2013-07-01T18:19:29+01:00"><meta property="og:site_name" content="Michal Konturek"><meta property="article:published_time" content="2013-07-01 18:19:29 +0100 +0100"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://michal.codes/about>About</a></li><li><a href=https://michal.codes/posts>Posts</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 minutes</p></div><article><h1 class=post-title><a href=https://michal.codes/posts/implementing-unit-conversion-library/>Implementing Unit conversion library</a></h1><div class=post-content><p>Last week I decided to implement unit conversion library for Objective-C called <a href=https://github.com/michalkonturek/MKUnits>MKUnits</a>. I was fully aware that there were many open-sourced implementation already available, but unfortunately none of them fitted my needs.</p><p>I required a library that:</p><ul><li>is easily extendable</li><li>has built-in rounding functionality</li><li>is precise up to at least 10 decimal places</li><li>allows manipulation between units of the same group, i.e. kg and pounds, without the need of conversion</li></ul><h3 id=quantity-pattern>Quantity Pattern</h3><p>Before I started coding, I had a quick read through the chapter of <a href=http://www.amazon.co.uk/Analysis-Patterns-Reusable-Object-Models/dp/0201895420>Analysis Patterns</a> by <a href=http://martinfowler.com/>Martin Fowler</a>, which describes the <strong>Quantity Pattern</strong>. This pattern is extremely useful when you want to represent dimensioned quantities.</p><p>The idea behind this pattern is straightforward; it is a class that represents both the <code>amount</code> and the <code>unit</code>, and allows arithmetic behaviour, e.g. addition and subtraction, and conversion to other quantities.</p><p>The initial interface for the <code>MKQuantity</code> was:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift>@<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MKUnit</span>;

@interface MKQuantity : NSObject

@property (nonatomic, copy) NSDecimalNumber <span style=color:#f92672>*</span>amount;
@property (nonatomic, strong) MKUnit <span style=color:#f92672>*</span>unit;

<span style=color:#f92672>-</span> (id)initWithAmount:(NSNumber <span style=color:#f92672>*</span>)amount withUnit:(MKUnit <span style=color:#f92672>*</span>)unit;

<span style=color:#f92672>-</span> (instancetype)add:(MKQuantity <span style=color:#f92672>*</span>)other;
<span style=color:#f92672>-</span> (instancetype)subtract:(MKQuantity <span style=color:#f92672>*</span>)other;

<span style=color:#f92672>-</span> (instancetype)convertTo:(MKUnit <span style=color:#f92672>*</span>)unit;

<span style=color:#f92672>-</span> (NSComparisonResult)compare:(MKQuantity <span style=color:#f92672>*</span>)other;

@end
</code></pre></div><p>Also, it&rsquo;s worth to mention that <code>MKQuantity</code> is a <strong>value object</strong>.</p><blockquote><p>A <strong>value object</strong> is a simple object whose equality is not based on identity.</p></blockquote><p>In other words, two value objects are equal if all their attributes are equal. In this case, it is <code>amount</code> and <code>unit</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#f92672>-</span> (BOOL)isEqual:(id)object {
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>[object isKindOfClass:[<span style=color:#66d9ef>self</span> <span style=color:#66d9ef>class</span>]]) <span style=color:#66d9ef>return</span> NO;
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>[[object unit] isEqual:<span style=color:#66d9ef>self</span>.unit]) <span style=color:#66d9ef>return</span> NO;
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>self</span>.amount isEqual:[object amount]];
}

<span style=color:#f92672>-</span> (NSUInteger)hash {
    <span style=color:#66d9ef>return</span> [[NSString stringWithFormat:@<span style=color:#e6db74>&#34;%@%@%@&#34;</span>,
             [<span style=color:#66d9ef>self</span> <span style=color:#66d9ef>class</span>], <span style=color:#66d9ef>self</span>.unit.symbol, <span style=color:#66d9ef>self</span>.amount] hash];
}
</code></pre></div><p><code>MKQuantity</code> is associated with <code>MKUnit</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift>@interface MKUnit : NSObject&lt;NSCopying&gt;

@property (nonatomic, strong) NSString <span style=color:#f92672>*</span>name;
@property (nonatomic, strong) NSString <span style=color:#f92672>*</span>symbol;
@property (nonatomic, strong) NSDecimalNumber <span style=color:#f92672>*</span>ratio;

<span style=color:#f92672>-</span> (id)initWithName:(NSString <span style=color:#f92672>*</span>)name
        withSymbol:(NSString <span style=color:#f92672>*</span>)symbol
        withRatio:(NSDecimalNumber <span style=color:#f92672>*</span>)ratio;

@end
</code></pre></div><p>The <code>ratio</code> property is used to convert unit to base unit, eg. for Length a base unit is <code>meter</code>, therefore, the ratio for <code>kilometer</code> unit is 1000 as <code>amount_in_meters = 1000 * amount_in_kilometers</code>.</p><h3 id=unit-conversion>Unit conversion</h3><p>Since this is a unit conversion library, the first type of a behaviour to be added is conversion.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#f92672>-</span> (instancetype)convertTo:(MKUnit <span style=color:#f92672>*</span>)unit {
    [<span style=color:#66d9ef>self</span> _assert_that_is_convertible_with_unit:unit];

    id converted = [<span style=color:#66d9ef>self</span>.unit convertAmount:<span style=color:#66d9ef>self</span>.amount to:unit];
    <span style=color:#66d9ef>return</span> [[<span style=color:#66d9ef>self</span> <span style=color:#66d9ef>class</span>] createWithAmount:converted withUnit:unit];
}
</code></pre></div><p>The conversion process of unit A to unit B consists of:</p><ul><li>asserting that unit A is convertible with unit B</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#f92672>-</span> (void)_assert_that_is_convertible_with_unit:(MKUnit <span style=color:#f92672>*</span>)unit {
    NSAssert(
      [<span style=color:#66d9ef>self</span>.unit isConvertibleWith:unit],
      UNITS_NOT_CONVERTIBLE
      );
}
</code></pre></div><p>The aim is to perform conversion and arithmetic operations not only on the same units, but also on the other units of the same quantity, eg. adding 500 pounds to 2.5 kilograms should be allowed, but adding 500 grams to 1 meter should not.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#f92672>-</span> (BOOL)isConvertibleWith:(MKUnit <span style=color:#f92672>*</span>)unit {
    <span style=color:#66d9ef>return</span> [unit isMemberOfClass:[<span style=color:#66d9ef>self</span> <span style=color:#66d9ef>class</span>]];
}
</code></pre></div><ul><li>converting <code>amount</code> of unit A to <code>amount</code> of unit B</li></ul><p>Firstly the <code>amount</code> of unit A must be converted to <code>amount</code> of base unit, and then the result is converted to <code>amount</code> of unit B.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#f92672>-</span> (NSNumber <span style=color:#f92672>*</span>)convertAmount:(NSNumber <span style=color:#f92672>*</span>)amount to:(MKUnit <span style=color:#f92672>*</span>)unit {
    <span style=color:#66d9ef>return</span> [<span style=color:#66d9ef>self</span> convertAmount:amount from:<span style=color:#66d9ef>self</span> to:unit];
}

<span style=color:#f92672>-</span> (NSNumber <span style=color:#f92672>*</span>)convertAmount:(NSNumber <span style=color:#f92672>*</span>)amount
                       from:(MKUnit <span style=color:#f92672>*</span>)from to:(MKUnit <span style=color:#f92672>*</span>)to {
    NSAssert([from isConvertibleWith:to], UNITS_NOT_CONVERTIBLE);

    id baseAmount = [from convertToBaseUnit:amount];
    id converted = [to convertFromBaseUnit:baseAmount];
    <span style=color:#66d9ef>return</span> converted;
}
</code></pre></div><ul><li>creating new <code>Quantity</code> object of unit B with converted <code>amount</code></li></ul><p>This is due general consensus that a <code>Value Object</code> should be entirely immutable.</p><h3 id=arithmetic>Arithmetic</h3><p>Addition and subtraction operations of two quantities are allowed as long as their units are convertible.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=color:#f92672>-</span> (instancetype)add:(MKQuantity <span style=color:#f92672>*</span>)other {
    MKQuantity <span style=color:#f92672>*</span>converted = [other convertTo:<span style=color:#66d9ef>self</span>.unit];
    id amount = [<span style=color:#66d9ef>self</span>.amount decimalNumberByAdding:converted.amount];
    <span style=color:#66d9ef>return</span> [[<span style=color:#66d9ef>self</span> <span style=color:#66d9ef>class</span>] createWithAmount:amount withUnit:<span style=color:#66d9ef>self</span>.unit];
}

<span style=color:#f92672>-</span> (instancetype)subtract:(MKQuantity <span style=color:#f92672>*</span>)other {
    MKQuantity <span style=color:#f92672>*</span>converted = [other convertTo:<span style=color:#66d9ef>self</span>.unit];
    id amount = [<span style=color:#66d9ef>self</span>.amount decimalNumberBySubtracting:converted.amount];
    <span style=color:#66d9ef>return</span> [[<span style=color:#66d9ef>self</span> <span style=color:#66d9ef>class</span>] createWithAmount:amount withUnit:<span style=color:#66d9ef>self</span>.unit];
}
</code></pre></div><p><strong>NB</strong> As this is a unit conversion library, we should only allow multiplication and division by scalar numbers.</p><p>If you would like to know more, please visit <a href=https://github.com/michalkonturek/MKUnits>MKUnits GitHub repository</a>.</p><p>I am <a href=http://twitter.com/michalkonturek>@michalkonturek</a> on Twitter.</p><p>Looking forward to your feedback.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://michal.codes/tags/ios>ios</a></span><span class=tag><a href=https://michal.codes/tags/swift>swift</a></span><span class=tag><a href=https://michal.codes/tags/oss>oss</a></span><span class=tag><a href=https://michal.codes/tags/patterns>patterns</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>639 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2013-07-01 17:19 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://michal.codes/posts/integrating-cocoapods-with-a-swift-project/><span class=button__icon>←</span>
<span class=button__text>Integrating Cocoapods with a Swift project</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://michal.codes>Michal Konturek</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://michal.codes/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Theme made by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.4a69500057d68129e88f497d354afe68422eb56de6d15e45dbe2190858ea5a76bfcb096406f992984b241db45f47388ac57ab0376e3b32125bef7a8a6d0f06c4.js integrity="sha512-SmlQAFfWgSnoj0l9NUr+aEIutW3m0V5F2+IZCFjqWna/ywlkBvmSmEskHbRfRziKxXqwN247MhJb73qKbQ8GxA=="></script></body></html>